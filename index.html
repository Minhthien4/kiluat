<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Kỷ Luật Thép - Modern</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6; /* Gray-100 */
        -webkit-tap-highlight-color: transparent;
        overflow: hidden; /* Prevent scrolling body, scroll content instead */
      }

      /* App Container */
      #app-container {
        height: 100vh;
        display: flex;
        flex-direction: column;
        max-width: 600px; /* Limit width on desktop */
        margin: 0 auto;
        background: white;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        position: relative;
      }

      /* Content Area with Scroll */
      #main-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        position: relative;
        padding-bottom: 80px; /* Space for bottom nav */
        scroll-behavior: smooth;
      }

      #main-content::-webkit-scrollbar {
        width: 4px;
      }
      #main-content::-webkit-scrollbar-thumb {
        background-color: #ddd;
        border-radius: 4px;
      }

      /* Navigation Bar */
      .bottom-nav {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: space-around;
        padding: 12px 0;
        padding-bottom: calc(
          12px + env(safe-area-inset-bottom)
        ); /* iOS safe area */
        z-index: 40;
        box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.02);
      }

      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: #9ca3af; /* Gray-400 */
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .nav-item i {
        font-size: 1.25rem;
        margin-bottom: 4px;
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      .nav-item.active {
        color: #3b82f6; /* Blue-500 */
        font-weight: 600;
      }
      .nav-item.active i {
        transform: translateY(-2px);
      }

      /* View Transitions */
      .view-section {
        width: 100%;
        min-height: 100%;
        padding: 20px;
        animation: fadeIn 0.3s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Calendar Styles */
      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
      }

      .cal-day {
        aspect-ratio: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        font-size: 0.9rem;
        position: relative;
        cursor: pointer;
        background: #fff;
        transition: all 0.2s;
        border: 1px solid transparent;
      }

      .cal-day:hover {
        background: #f9fafb;
      }

      /* Past Day Style */
      .cal-day.past {
        background: #f3f4f6;
        color: #9ca3af;
        border: 1px solid transparent;
      }
      .cal-day.past .dot {
        opacity: 0.5;
      }

      /* Today Style */
      .cal-day.today {
        background: #eff6ff;
        color: #3b82f6;
        font-weight: bold;
        border: 1px solid #bfdbfe;
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1);
      }

      /* IMPORTANT DAY STYLE */
      .cal-day.day-important {
        background-color: #fef2f2; /* Red-50 */
        color: #dc2626; /* Red-600 */
        border: 1px solid #fecaca; /* Red-200 */
      }
      .cal-day.day-important.today {
        border: 2px solid #dc2626; /* Strong Red Border if today is important */
      }

      /* Indicators for tasks */
      .dot-indicators {
        display: flex;
        gap: 2px;
        margin-top: 4px;
      }
      .dot {
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background-color: #d1d5db; /* Default gray for past/missed */
      }
      .dot.active {
        background-color: #3b82f6;
      }
      .dot.completed {
        background-color: #10b981;
      }
      .dot.tag-important {
        background-color: #ef4444;
      } /* Red dot for tasks */

      /* Contribution Graph */
      .contribution-grid {
        display: grid;
        grid-template-columns: repeat(20, 1fr);
        gap: 3px;
      }
      .contrib-box {
        aspect-ratio: 1;
        border-radius: 3px;
        background-color: #f3f4f6;
      }
      .contrib-1 {
        background-color: #bbf7d0;
      }
      .contrib-2 {
        background-color: #4ade80;
      }
      .contrib-3 {
        background-color: #22c55e;
      }
      .contrib-4 {
        background-color: #15803d;
      }

      /* Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(4px);
        z-index: 100;
        display: flex;
        align-items: flex-end; /* Bottom sheet on mobile */
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }

      @media (min-width: 640px) {
        .modal-overlay {
          align-items: center;
          justify-content: center;
        }
      }

      .modal-overlay.open {
        opacity: 1;
        pointer-events: auto;
      }

      .modal-content {
        background: white;
        width: 100%;
        max-width: 600px; /* Match app width */
        border-radius: 20px 20px 0 0;
        padding: 24px;
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.33, 1, 0.68, 1);
        max-height: 80vh;
        display: flex;
        flex-direction: column;
      }

      @media (min-width: 640px) {
        .modal-content {
          width: 90%;
          max-width: 400px;
          border-radius: 20px;
          transform: scale(0.95);
        }
      }

      .modal-overlay.open .modal-content {
        transform: translateY(0);
      }
      @media (min-width: 640px) {
        .modal-overlay.open .modal-content {
          transform: scale(1);
        }
      }

      /* Confirm Modal specific overrides */
      #confirmModal .modal-content,
      #noteModal .modal-content {
        align-items: center;
        text-align: center;
        padding-bottom: 30px;
      }
      @media (min-width: 640px) {
        #confirmModal .modal-content,
        #noteModal .modal-content {
          max-width: 320px;
          border-radius: 20px;
        }
      }

      /* Checkbox Custom */
      .custom-checkbox input:checked + div {
        background-color: #10b981;
        border-color: #10b981;
      }
      .custom-checkbox input:disabled + div {
        background-color: #10b981;
        border-color: #10b981;
        opacity: 0.8;
        cursor: not-allowed;
      }
      .custom-checkbox input:checked + div svg {
        display: block;
      }

      /* Custom Time Select */
      .time-select-wrapper {
        position: relative;
      }
      .time-select-wrapper select {
        appearance: none;
        -webkit-appearance: none;
        background: white;
        text-align: center;
      }

      /* Tag Styles */
      .tag-btn {
        border: 1px solid #e5e7eb;
        transition: all 0.2s;
      }
      .tag-btn.selected {
        border-color: transparent;
        color: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
      .tag-normal.selected {
        background-color: #6b7280;
      }
      .tag-important.selected {
        background-color: #ef4444;
      }
      .tag-work.selected {
        background-color: #f59e0b;
      }
      .tag-study.selected {
        background-color: #3b82f6;
      }

      /* Tag Badges for List */
      .badge-tag {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
      }
      .badge-normal {
        background: #f3f4f6;
        color: #6b7280;
      }
      .badge-important {
        background: #fef2f2;
        color: #ef4444;
        border: 1px solid #fecaca;
      }
      .badge-work {
        background: #fffbeb;
        color: #d97706;
      }
      .badge-study {
        background: #eff6ff;
        color: #3b82f6;
      }

      /* Monthly Day Grid */
      .month-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }
      .month-day-cell {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        border: 1px solid #e5e7eb;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .month-day-cell.selected {
        background-color: #db2777; /* Pink-600 */
        color: white;
        border-color: #db2777;
      }
    </style>
  </head>
  <body>
    <div id="app-container">
      <!-- Header -->
      <header class="px-5 pt-6 pb-2 bg-white sticky top-0 z-30">
        <div class="flex justify-between items-end">
          <div>
            <p
              class="text-xs text-gray-400 font-medium uppercase tracking-wider"
              id="headerDate"
            >
              THỨ NĂM, 12 THÁNG 12
            </p>
            <h1 class="text-2xl font-bold text-gray-800 mt-1" id="headerTitle">
              Lịch Trình
            </h1>
          </div>
          <div
            class="w-8 h-8 rounded-full overflow-hidden border border-gray-200"
            onclick="navTo('profile')"
          >
            <img
              src="https://api.dicebear.com/7.x/avataaars/svg?seed=Thien&backgroundColor=b6e3f4"
              alt="Avatar"
            />
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <div id="main-content">
        <!-- VIEW 1: CALENDAR -->
        <div id="view-calendar" class="view-section">
          <!-- Month Navigator -->
          <div
            class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 mb-4"
          >
            <div class="calendar-header">
              <button
                onclick="changeMonth(-1)"
                class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600 transition"
              >
                <i class="fas fa-chevron-left"></i>
              </button>
              <span class="text-lg font-bold text-gray-800" id="calendarTitle"
                >Tháng 12 2023</span
              >
              <button
                onclick="changeMonth(1)"
                class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600 transition"
              >
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>

            <div
              class="grid grid-cols-7 gap-8 mb-2 text-center text-xs font-semibold text-gray-400"
            >
              <div>CN</div>
              <div>T2</div>
              <div>T3</div>
              <div>T4</div>
              <div>T5</div>
              <div>T6</div>
              <div>T7</div>
            </div>
            <div id="calendarDays" class="calendar-grid">
              <!-- JS renders days -->
            </div>

            <!-- LEGEND -->
            <div class="mt-6 pt-4 border-t border-gray-100">
              <p class="text-[10px] text-gray-400 uppercase font-bold mb-2">
                Chú thích lịch
              </p>
              <div class="flex flex-wrap gap-x-4 gap-y-2 text-xs text-gray-600">
                <div class="flex items-center gap-1.5">
                  <div
                    class="w-4 h-4 rounded bg-red-50 border border-red-200 text-red-600 flex items-center justify-center text-[8px] font-bold"
                  >
                    12
                  </div>
                  <span>Quan trọng</span>
                </div>
                <div class="flex items-center gap-1.5">
                  <div class="w-2 h-2 rounded-full bg-green-500"></div>
                  <span>Đã hoàn thành</span>
                </div>
                <div class="flex items-center gap-1.5">
                  <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                  <span>Chưa làm</span>
                </div>
                <div class="flex items-center gap-1.5">
                  <div class="w-2 h-2 rounded-full bg-gray-300"></div>
                  <span>Đã qua</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Today's Tasks Preview -->
          <div class="mb-6">
            <h3
              class="text-lg font-bold text-gray-800 mb-3 px-1 flex items-center gap-2"
            >
              <span class="w-2 h-2 rounded-full bg-blue-500"></span> Hôm nay
            </h3>
            <div id="todayPreview" class="space-y-3">
              <!-- Rendered by JS -->
            </div>
          </div>

          <!-- Tomorrow's Tasks Preview -->
          <div class="mb-4">
            <h3
              class="text-lg font-bold text-gray-500 mb-3 px-1 flex items-center gap-2"
            >
              <span class="w-2 h-2 rounded-full bg-orange-300"></span> Ngày mai
            </h3>
            <div id="tomorrowPreview" class="space-y-3 opacity-90">
              <!-- Rendered by JS -->
            </div>
          </div>
        </div>

        <!-- VIEW 2: ADD / MANAGE -->
        <div id="view-add" class="view-section hidden">
          <div
            class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-6"
          >
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-bold text-gray-800" id="formTitle">
                Tạo thói quen mới
              </h2>
              <button
                type="button"
                id="btnCancelEdit"
                onclick="cancelEdit()"
                class="hidden text-sm text-gray-500 hover:text-gray-800 underline"
              >
                Hủy sửa
              </button>
            </div>

            <form id="taskForm" class="space-y-4">
              <div>
                <label
                  class="block text-xs font-semibold text-gray-500 uppercase mb-1"
                  >Tên công việc</label
                >
                <input
                  type="text"
                  id="taskTitle"
                  required
                  class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:border-blue-500 focus:bg-white transition"
                  placeholder="Ví dụ: Tập Gym, Học Tiếng Anh..."
                />
              </div>

              <!-- Note Field -->
              <div>
                <label
                  class="block text-xs font-semibold text-gray-500 uppercase mb-1"
                  >Ghi chú (Tùy chọn)</label
                >
                <textarea
                  id="taskNote"
                  rows="2"
                  class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:border-blue-500 focus:bg-white transition resize-none"
                  placeholder="Chi tiết..."
                ></textarea>
              </div>

              <!-- Tag Selector -->
              <div>
                <label
                  class="block text-xs font-semibold text-gray-500 uppercase mb-2"
                  >Loại / Mức độ</label
                >
                <div class="flex flex-wrap gap-2">
                  <button
                    type="button"
                    onclick="setTag('normal')"
                    class="tag-btn tag-normal selected px-3 py-1.5 rounded-lg text-xs font-medium"
                    data-tag="normal"
                  >
                    Bình thường
                  </button>
                  <button
                    type="button"
                    onclick="setTag('important')"
                    class="tag-btn tag-important px-3 py-1.5 rounded-lg text-xs font-medium bg-white text-gray-600"
                    data-tag="important"
                  >
                    Quan trọng
                  </button>
                  <button
                    type="button"
                    onclick="setTag('work')"
                    class="tag-btn tag-work px-3 py-1.5 rounded-lg text-xs font-medium bg-white text-gray-600"
                    data-tag="work"
                  >
                    Công việc
                  </button>
                  <button
                    type="button"
                    onclick="setTag('study')"
                    class="tag-btn tag-study px-3 py-1.5 rounded-lg text-xs font-medium bg-white text-gray-600"
                    data-tag="study"
                  >
                    Học tập
                  </button>
                </div>
              </div>

              <!-- Custom Scroll Time Picker -->
              <div>
                <label
                  class="block text-xs font-semibold text-gray-500 uppercase mb-1"
                  >Thời gian</label
                >
                <div class="flex gap-2 items-center">
                  <div class="time-select-wrapper flex-1">
                    <select
                      id="taskHour"
                      class="w-full h-12 rounded-xl border border-gray-200 text-lg font-bold text-gray-700 outline-none focus:border-blue-500"
                    >
                      <!-- JS fills 00-23 -->
                    </select>
                  </div>
                  <span class="text-xl font-bold text-gray-400">:</span>
                  <div class="time-select-wrapper flex-1">
                    <select
                      id="taskMinute"
                      class="w-full h-12 rounded-xl border border-gray-200 text-lg font-bold text-gray-700 outline-none focus:border-blue-500"
                    >
                      <!-- JS fills 00-55 -->
                    </select>
                  </div>
                </div>
              </div>

              <!-- Repeat Logic -->
              <div>
                <label
                  class="block text-xs font-semibold text-gray-500 uppercase mb-2"
                  >Tần suất lặp lại</label
                >
                <div class="flex flex-wrap gap-2 mb-3">
                  <button
                    type="button"
                    onclick="setRepeatType('once')"
                    class="repeat-btn py-2 px-3 rounded-lg text-sm font-medium transition border border-gray-200 bg-gray-800 text-white shadow-md"
                    data-type="once"
                  >
                    Một lần
                  </button>
                  <button
                    type="button"
                    onclick="setRepeatType('daily')"
                    class="repeat-btn py-2 px-3 rounded-lg text-sm font-medium transition border border-gray-200 text-gray-600 bg-white"
                    data-type="daily"
                  >
                    Hàng ngày
                  </button>
                  <button
                    type="button"
                    onclick="setRepeatType('weekly')"
                    class="repeat-btn py-2 px-3 rounded-lg text-sm font-medium transition border border-gray-200 text-gray-600 bg-white"
                    data-type="weekly"
                  >
                    Hàng tuần
                  </button>
                  <button
                    type="button"
                    onclick="setRepeatType('monthly')"
                    class="repeat-btn py-2 px-3 rounded-lg text-sm font-medium transition border border-gray-200 text-gray-600 bg-white"
                    data-type="monthly"
                  >
                    Hàng tháng
                  </button>
                  <button
                    type="button"
                    onclick="setRepeatType('yearly')"
                    class="repeat-btn py-2 px-3 rounded-lg text-sm font-medium transition border border-gray-200 text-gray-600 bg-white"
                    data-type="yearly"
                  >
                    Hàng năm
                  </button>
                </div>

                <!-- Weekly Selector: Days of Week -->
                <div id="weekDaysSelector" class="hidden">
                  <p class="text-[10px] text-gray-400 uppercase font-bold mb-2">
                    Chọn thứ trong tuần:
                  </p>
                  <div
                    class="flex justify-between gap-1 bg-gray-50 p-3 rounded-xl"
                  >
                    <div
                      onclick="toggleDay(0)"
                      class="day-bubble w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center cursor-pointer text-xs font-medium text-gray-500 hover:border-blue-400 transition"
                      data-day="0"
                    >
                      CN
                    </div>
                    <div
                      onclick="toggleDay(1)"
                      class="day-bubble w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center cursor-pointer text-xs font-medium text-gray-500 hover:border-blue-400 transition"
                      data-day="1"
                    >
                      T2
                    </div>
                    <div
                      onclick="toggleDay(2)"
                      class="day-bubble w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center cursor-pointer text-xs font-medium text-gray-500 hover:border-blue-400 transition"
                      data-day="2"
                    >
                      T3
                    </div>
                    <div
                      onclick="toggleDay(3)"
                      class="day-bubble w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center cursor-pointer text-xs font-medium text-gray-500 hover:border-blue-400 transition"
                      data-day="3"
                    >
                      T4
                    </div>
                    <div
                      onclick="toggleDay(4)"
                      class="day-bubble w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center cursor-pointer text-xs font-medium text-gray-500 hover:border-blue-400 transition"
                      data-day="4"
                    >
                      T5
                    </div>
                    <div
                      onclick="toggleDay(5)"
                      class="day-bubble w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center cursor-pointer text-xs font-medium text-gray-500 hover:border-blue-400 transition"
                      data-day="5"
                    >
                      T6
                    </div>
                    <div
                      onclick="toggleDay(6)"
                      class="day-bubble w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center cursor-pointer text-xs font-medium text-gray-500 hover:border-blue-400 transition"
                      data-day="6"
                    >
                      T7
                    </div>
                  </div>
                </div>

                <!-- Monthly Selector: Days of Month -->
                <div id="monthDaysSelector" class="hidden">
                  <p class="text-[10px] text-gray-400 uppercase font-bold mb-2">
                    Chọn ngày trong tháng (vd: ngày 5, 20...):
                  </p>
                  <div
                    class="bg-gray-50 p-3 rounded-xl month-grid"
                    id="monthGridContainer"
                  >
                    <!-- JS generates 1-31 bubbles -->
                  </div>
                </div>

                <!-- Date Picker for Once & Yearly -->
                <div id="datePickerContainer" class="mt-3">
                  <p id="datePickerLabel" class="text-xs text-gray-400 mb-1">
                    Chọn ngày:
                  </p>
                  <input
                    type="date"
                    id="taskDate"
                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none"
                  />
                  <p
                    id="yearlyHint"
                    class="hidden text-xs text-purple-500 mt-2 italic"
                  >
                    Lịch sẽ lặp lại vào ngày/tháng này hàng năm.
                  </p>
                </div>
              </div>

              <button
                type="submit"
                id="btnSubmitTask"
                class="w-full mt-4 bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 hover:bg-blue-700 transition active:scale-95 flex items-center justify-center"
              >
                <i class="fas fa-plus mr-2"></i> Thêm vào lịch
              </button>
            </form>
          </div>

          <div class="mb-20">
            <h3 class="text-sm font-bold text-gray-400 uppercase mb-3 px-1">
              Danh sách công việc đang theo dõi
            </h3>
            <div id="taskList" class="space-y-3">
              <!-- List items -->
            </div>
          </div>
        </div>

        <!-- VIEW 3: PROFILE -->
        <div id="view-profile" class="view-section hidden">
          <!-- Profile content same as before -->
          <div
            class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg shadow-blue-200 mb-6"
          >
            <div class="flex items-center gap-4">
              <div
                class="w-20 h-20 rounded-full border-4 border-white/30 bg-white/20 overflow-hidden"
              >
                <img
                  src="https://api.dicebear.com/7.x/avataaars/svg?seed=Thien&backgroundColor=b6e3f4"
                  alt="Avatar"
                  class="w-full h-full object-cover"
                />
              </div>
              <div>
                <h2 class="text-2xl font-bold">Trần Minh Thiện</h2>
                <p class="text-blue-100 text-sm mt-1 flex items-center">
                  <i class="fas fa-medal mr-1"></i> Thành viên Kỷ luật
                </p>
              </div>
            </div>

            <div class="flex mt-6 gap-4">
              <div
                class="flex-1 bg-white/10 rounded-xl p-3 backdrop-blur-sm text-center"
              >
                <div class="text-2xl font-bold" id="totalTasksCount">0</div>
                <div class="text-xs text-blue-100">Đã hoàn thành</div>
              </div>
              <div
                class="flex-1 bg-white/10 rounded-xl p-3 backdrop-blur-sm text-center"
              >
                <div class="text-2xl font-bold" id="streakCount">0</div>
                <div class="text-xs text-blue-100">Chuỗi ngày</div>
              </div>
            </div>
          </div>

          <div
            class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-6"
          >
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-gray-800">Bản đồ hoạt động</h3>
              <span class="text-xs text-gray-400">60 ngày gần nhất</span>
            </div>
            <div id="contributionGraph" class="contribution-grid">
              <!-- Generated by JS -->
            </div>
            <!-- Contribution Legend -->
            <div
              class="flex items-center justify-end gap-2 mt-3 text-xs text-gray-500"
            >
              <span>Ít</span>
              <div class="w-3 h-3 rounded bg-gray-100"></div>
              <div class="w-3 h-3 rounded bg-[#bbf7d0]"></div>
              <div class="w-3 h-3 rounded bg-[#4ade80]"></div>
              <div class="w-3 h-3 rounded bg-[#22c55e]"></div>
              <div class="w-3 h-3 rounded bg-[#15803d]"></div>
              <span>Nhiều</span>
            </div>
          </div>

          <button
            onclick="clearAllData()"
            class="w-full py-4 text-red-500 font-medium rounded-xl bg-red-50 hover:bg-red-100 transition"
          >
            <i class="fas fa-trash-alt mr-2"></i> Xóa toàn bộ dữ liệu
          </button>
        </div>
      </div>

      <!-- Bottom Navigation -->
      <nav class="bottom-nav">
        <div
          class="nav-item active"
          onclick="navTo('calendar')"
          id="nav-calendar"
        >
          <i class="fas fa-calendar-day"></i>
          <span>Lịch</span>
        </div>
        <div class="nav-item" onclick="navTo('add')" id="nav-add">
          <div
            class="bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center -mt-3 shadow-lg shadow-blue-200"
          >
            <i class="fas fa-plus !text-lg !m-0 !transform-none"></i>
          </div>
          <span class="mt-1">Thêm</span>
        </div>
        <div class="nav-item" onclick="navTo('profile')" id="nav-profile">
          <i class="fas fa-user"></i>
          <span>Cá nhân</span>
        </div>
      </nav>
    </div>

    <!-- Modals: Day Detail, Confirm Delete, View Note (Same structure) -->
    <div id="dayModal" class="modal-overlay z-[100]">
      <div class="modal-content">
        <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6"></div>
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 id="modalDateTitle" class="text-2xl font-bold text-gray-800">
              12/12/2023
            </h3>
            <p class="text-sm text-gray-500">Danh sách nhiệm vụ</p>
          </div>
          <button
            onclick="closeModal()"
            class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div
          id="modalTaskList"
          class="flex-1 overflow-y-auto space-y-3 mb-4 pr-1"
        ></div>
        <button
          onclick="navTo('add'); closeModal()"
          class="w-full py-3 text-blue-600 font-bold bg-blue-50 rounded-xl hover:bg-blue-100 transition mt-2"
        >
          + Thêm việc mới
        </button>
      </div>
    </div>

    <div id="confirmModal" class="modal-overlay z-[110]">
      <div class="modal-content">
        <div class="flex flex-col items-center justify-center w-full pt-2">
          <div
            class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4"
          >
            <i class="fas fa-trash-alt text-2xl text-red-500"></i>
          </div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">Xác nhận xóa?</h3>
          <p class="text-sm text-gray-500 mb-6 text-center px-4">
            Bạn có chắc chắn muốn xóa nhiệm vụ này không?
          </p>
          <div class="flex gap-3 w-full">
            <button
              onclick="closeConfirmModal()"
              class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 transition"
            >
              Hủy
            </button>
            <button
              onclick="executeDelete()"
              class="flex-1 py-3 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600 transition shadow-lg shadow-red-200"
            >
              Xóa ngay
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="noteModal" class="modal-overlay z-[110]">
      <div class="modal-content">
        <div class="flex flex-col items-center justify-center w-full pt-2">
          <div
            class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-4"
          >
            <i class="fas fa-sticky-note text-2xl text-blue-500"></i>
          </div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">Ghi chú</h3>
          <div
            class="bg-gray-50 rounded-xl p-4 w-full mb-4 border border-gray-100 text-left max-h-60 overflow-y-auto"
          >
            <p
              id="noteContent"
              class="text-sm text-gray-700 leading-relaxed italic whitespace-pre-wrap"
            ></p>
          </div>
          <button
            onclick="closeNoteModal()"
            class="w-full py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 transition"
          >
            Đóng
          </button>
        </div>
      </div>
    </div>

    <script>
      let tasks = JSON.parse(localStorage.getItem("tasks")) || [];
      let currentView = "calendar";
      let viewDate = new Date();
      let selectedDateStr = "";
      let pendingDeleteId = null;
      let editingTaskId = null;

      // New State for Monthly Selection
      let selectedMonthDays = [];

      // --- INIT ---
      document.addEventListener("DOMContentLoaded", () => {
        initDateHeader();
        initTimePickers();
        initMonthGrid(); // Build 1-31 grid
        renderCalendar();

        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        renderTaskPreviews(getLocalISODate(today), "todayPreview");
        renderTaskPreviews(getLocalISODate(tomorrow), "tomorrowPreview");

        document.getElementById("taskDate").valueAsDate = today;
        document.getElementById("taskDate").min = getLocalISODate(today);
      });

      function getLocalISODate(d) {
        const offset = d.getTimezoneOffset() * 60000;
        const localISOTime = new Date(d - offset).toISOString().slice(0, 10);
        return localISOTime;
      }

      function initDateHeader() {
        const today = new Date();
        const options = { weekday: "long", day: "numeric", month: "numeric" };
        document.getElementById("headerDate").innerText =
          today.toLocaleDateString("vi-VN", options);
      }

      function initTimePickers() {
        const hSelect = document.getElementById("taskHour");
        const mSelect = document.getElementById("taskMinute");
        for (let i = 0; i < 24; i++) {
          const opt = document.createElement("option");
          opt.value = i.toString().padStart(2, "0");
          opt.text = i.toString().padStart(2, "0");
          hSelect.add(opt);
        }
        hSelect.value = new Date().getHours().toString().padStart(2, "0");
        for (let i = 0; i < 60; i += 5) {
          const opt = document.createElement("option");
          opt.value = i.toString().padStart(2, "0");
          opt.text = i.toString().padStart(2, "0");
          mSelect.add(opt);
        }
        mSelect.value = "00";
      }

      function initMonthGrid() {
        const grid = document.getElementById("monthGridContainer");
        grid.innerHTML = "";
        for (let i = 1; i <= 31; i++) {
          const div = document.createElement("div");
          div.className =
            "month-day-cell bg-white text-gray-500 hover:bg-gray-100";
          div.innerText = i;
          div.onclick = () => toggleMonthDay(i, div);
          grid.appendChild(div);
        }
      }

      // --- NAVIGATION ---
      function navTo(viewId) {
        document
          .querySelectorAll(".nav-item")
          .forEach((el) => el.classList.remove("active"));
        if (viewId !== "add") {
          document.getElementById(`nav-${viewId}`).classList.add("active");
        } else {
          document.getElementById("nav-add").classList.add("active");
        }
        const titles = {
          calendar: "Lịch Trình",
          add: "Quản Lý",
          profile: "Hồ Sơ",
        };
        document.getElementById("headerTitle").innerText = titles[viewId];
        document
          .querySelectorAll(".view-section")
          .forEach((el) => el.classList.add("hidden"));
        document.getElementById(`view-${viewId}`).classList.remove("hidden");
        currentView = viewId;
        if (viewId === "calendar") renderCalendar();
        if (viewId === "add") renderTaskList();
        if (viewId === "profile") renderProfile();
      }

      // --- CALENDAR LOGIC ---
      function changeMonth(offset) {
        viewDate.setMonth(viewDate.getMonth() + offset);
        renderCalendar();
      }

      function renderCalendar() {
        const year = viewDate.getFullYear();
        const month = viewDate.getMonth();
        document.getElementById("calendarTitle").innerText = `Tháng ${
          month + 1
        }, ${year}`;

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDayIndex = firstDay.getDay();

        const grid = document.getElementById("calendarDays");
        grid.innerHTML = "";

        for (let i = 0; i < startDayIndex; i++) {
          grid.appendChild(document.createElement("div"));
        }

        const todayStr = getLocalISODate(new Date());

        for (let d = 1; d <= daysInMonth; d++) {
          const dateStr = `${year}-${String(month + 1).padStart(
            2,
            "0"
          )}-${String(d).padStart(2, "0")}`;
          const div = document.createElement("div");
          div.className = "cal-day";
          div.innerHTML = `<span class="z-10">${d}</span>`;

          if (dateStr === todayStr) div.classList.add("today");
          if (dateStr < todayStr) div.classList.add("past");

          const dayTasks = getTasksForDate(dateStr);

          const hasImportantTask = dayTasks.some((t) => t.tag === "important");
          if (hasImportantTask && dateStr >= todayStr) {
            div.classList.add("day-important");
          }

          if (dayTasks.length > 0) {
            const dotsDiv = document.createElement("div");
            dotsDiv.className = "dot-indicators";
            dayTasks.slice(0, 3).forEach((task) => {
              const isDone = task.completedDates.includes(dateStr);
              const dot = document.createElement("div");
              if (dateStr < todayStr) {
                dot.className = isDone ? `dot completed` : `dot`;
              } else {
                if (!isDone && task.tag === "important") {
                  dot.className = `dot tag-important`;
                } else {
                  dot.className = `dot ${isDone ? "completed" : "active"}`;
                }
              }
              dotsDiv.appendChild(dot);
            });
            div.appendChild(dotsDiv);
          }
          div.onclick = () => openDayModal(dateStr);
          grid.appendChild(div);
        }
      }

      function getTasksForDate(dateStr) {
        const checkDate = new Date(dateStr);
        const dayOfWeek = checkDate.getDay();
        const dayOfMonth = checkDate.getDate();
        const month = checkDate.getMonth() + 1; // 1-12

        return tasks
          .filter((task) => {
            if (task.repeatType === "daily") return true;
            if (task.repeatType === "weekly")
              return task.repeatDays.includes(dayOfWeek);
            if (task.repeatType === "monthly") {
              // Support legacy (single date) and new (array of days)
              if (task.repeatDays && task.repeatDays.length > 0) {
                return task.repeatDays.includes(dayOfMonth);
              }
              if (task.specificDate) {
                const targetDay = new Date(task.specificDate).getDate();
                return dayOfMonth === targetDay;
              }
            }
            if (task.repeatType === "yearly") {
              if (task.specificDate) {
                const targetDate = new Date(task.specificDate);
                return (
                  dayOfMonth === targetDate.getDate() &&
                  month === targetDate.getMonth() + 1
                );
              }
            }
            if (task.repeatType === "once")
              return task.specificDate === dateStr;
            return false;
          })
          .sort((a, b) => {
            if (a.tag === "important" && b.tag !== "important") return -1;
            if (a.tag !== "important" && b.tag === "important") return 1;
            return a.time.localeCompare(b.time);
          });
      }

      // --- ADD/EDIT LOGIC ---
      let selectedRepeat = "once";
      let selectedWeekDays = [];
      let selectedTag = "normal";

      function setRepeatType(type) {
        selectedRepeat = type;
        document.querySelectorAll(".repeat-btn").forEach((btn) => {
          btn.classList.remove("bg-gray-800", "text-white", "shadow-md");
          btn.classList.add("bg-white", "text-gray-600");
          if (btn.dataset.type === type) {
            btn.classList.remove("bg-white", "text-gray-600");
            btn.classList.add("bg-gray-800", "text-white", "shadow-md");
          }
        });

        const weekSelector = document.getElementById("weekDaysSelector");
        const monthSelector = document.getElementById("monthDaysSelector");
        const datePicker = document.getElementById("datePickerContainer");
        const yearlyHint = document.getElementById("yearlyHint");
        const dateLabel = document.getElementById("datePickerLabel");

        weekSelector.classList.add("hidden");
        monthSelector.classList.add("hidden");
        datePicker.classList.add("hidden");
        yearlyHint.classList.add("hidden");

        if (type === "weekly") {
          weekSelector.classList.remove("hidden");
        } else if (type === "monthly") {
          monthSelector.classList.remove("hidden");
        } else if (type === "once") {
          datePicker.classList.remove("hidden");
          dateLabel.innerText = "Chọn ngày thực hiện:";
        } else if (type === "yearly") {
          datePicker.classList.remove("hidden");
          dateLabel.innerText = "Chọn ngày (lặp lại hàng năm):";
          yearlyHint.classList.remove("hidden");
        }
      }

      function setTag(tag) {
        selectedTag = tag;
        document.querySelectorAll(".tag-btn").forEach((btn) => {
          btn.classList.remove("selected");
          btn.classList.add("bg-white", "text-gray-600");
          if (btn.dataset.tag === tag) {
            btn.classList.remove("bg-white", "text-gray-600");
            btn.classList.add("selected");
          }
        });
      }

      function toggleDay(dayIndex) {
        const el = document.querySelector(
          `.day-bubble[data-day="${dayIndex}"]`
        );
        if (selectedWeekDays.includes(dayIndex)) {
          selectedWeekDays = selectedWeekDays.filter((d) => d !== dayIndex);
          el.classList.remove("bg-blue-500", "text-white", "border-blue-500");
          el.classList.add("bg-white", "text-gray-500");
        } else {
          selectedWeekDays.push(dayIndex);
          el.classList.remove("bg-white", "text-gray-500");
          el.classList.add("bg-blue-500", "text-white", "border-blue-500");
        }
      }

      function toggleMonthDay(day, el) {
        if (selectedMonthDays.includes(day)) {
          selectedMonthDays = selectedMonthDays.filter((d) => d !== day);
          el.classList.remove("selected");
          el.classList.add("bg-white", "text-gray-500");
        } else {
          selectedMonthDays.push(day);
          el.classList.remove("bg-white", "text-gray-500");
          el.classList.add("selected");
        }
      }

      // EDIT TASK
      function editTask(id) {
        const task = tasks.find((t) => t.id === id);
        if (!task) return;

        editingTaskId = id;
        document.getElementById("taskTitle").value = task.title;
        const [h, m] = task.time.split(":");
        document.getElementById("taskHour").value = h;
        document.getElementById("taskMinute").value = m;
        document.getElementById("taskNote").value = task.note || "";
        setTag(task.tag);
        setRepeatType(task.repeatType);

        // Clear selections first
        selectedWeekDays = [];
        selectedMonthDays = [];

        // Reset visuals
        document.querySelectorAll(".day-bubble").forEach((el) => {
          el.classList.remove("bg-blue-500", "text-white", "border-blue-500");
          el.classList.add("bg-white", "text-gray-500");
        });
        document.querySelectorAll(".month-day-cell").forEach((el) => {
          el.classList.remove("selected");
          el.classList.add("bg-white", "text-gray-500");
        });

        if (task.repeatType === "weekly") {
          selectedWeekDays = [...task.repeatDays];
          document.querySelectorAll(".day-bubble").forEach((el) => {
            if (selectedWeekDays.includes(parseInt(el.dataset.day))) {
              el.classList.remove("bg-white", "text-gray-500");
              el.classList.add("bg-blue-500", "text-white", "border-blue-500");
            }
          });
        } else if (task.repeatType === "monthly") {
          // If using new array format
          if (task.repeatDays && task.repeatDays.length) {
            selectedMonthDays = [...task.repeatDays];
            // update grid UI
            const grid = document.getElementById("monthGridContainer");
            Array.from(grid.children).forEach((el) => {
              if (selectedMonthDays.includes(parseInt(el.innerText))) {
                el.classList.remove("bg-white", "text-gray-500");
                el.classList.add("selected");
              }
            });
          }
        }

        if (task.repeatType === "once" || task.repeatType === "yearly") {
          document.getElementById("taskDate").value = task.specificDate;
        }

        document.getElementById("formTitle").innerText = "Chỉnh sửa thói quen";
        document.getElementById("btnSubmitTask").innerHTML =
          '<i class="fas fa-save mr-2"></i> Lưu thay đổi';
        document
          .getElementById("btnSubmitTask")
          .classList.remove("bg-blue-600", "hover:bg-blue-700");
        document
          .getElementById("btnSubmitTask")
          .classList.add("bg-green-600", "hover:bg-green-700");
        document.getElementById("btnCancelEdit").classList.remove("hidden");

        document
          .getElementById("main-content")
          .scrollTo({ top: 0, behavior: "smooth" });
      }

      function cancelEdit() {
        editingTaskId = null;
        document.getElementById("taskForm").reset();
        setRepeatType("once");
        setTag("normal");
        selectedWeekDays = [];
        selectedMonthDays = [];

        document.querySelectorAll(".day-bubble").forEach((el) => {
          el.classList.remove("bg-blue-500", "text-white");
          el.classList.add("bg-white", "text-gray-500");
        });
        document.querySelectorAll(".month-day-cell").forEach((el) => {
          el.classList.remove("selected");
          el.classList.add("bg-white", "text-gray-500");
        });

        document.getElementById("formTitle").innerText = "Tạo thói quen mới";
        document.getElementById("btnSubmitTask").innerHTML =
          '<i class="fas fa-plus mr-2"></i> Thêm vào lịch';
        document
          .getElementById("btnSubmitTask")
          .classList.remove("bg-green-600", "hover:bg-green-700");
        document
          .getElementById("btnSubmitTask")
          .classList.add("bg-blue-600", "hover:bg-blue-700");
        document.getElementById("btnCancelEdit").classList.add("hidden");
        document.getElementById("taskDate").valueAsDate = new Date();
      }

      document.getElementById("taskForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const title = document.getElementById("taskTitle").value;
        const time = `${document.getElementById("taskHour").value}:${
          document.getElementById("taskMinute").value
        }`;
        const dateVal = document.getElementById("taskDate").value;
        const noteVal = document.getElementById("taskNote").value;
        const todayStr = getLocalISODate(new Date());

        if (selectedRepeat === "weekly" && selectedWeekDays.length === 0) {
          alert("Vui lòng chọn ngày trong tuần!");
          return;
        }
        if (selectedRepeat === "monthly" && selectedMonthDays.length === 0) {
          alert("Vui lòng chọn ít nhất một ngày trong tháng!");
          return;
        }
        if (
          (selectedRepeat === "once" || selectedRepeat === "yearly") &&
          !dateVal
        ) {
          alert("Vui lòng chọn ngày!");
          return;
        }

        if (
          (selectedRepeat === "once" || selectedRepeat === "yearly") &&
          dateVal < todayStr
        ) {
          alert("Kỷ luật thép: Không thể lên lịch cho quá khứ!");
          return;
        }

        // Determine repeatDays array based on type
        let finalRepeatDays = [];
        if (selectedRepeat === "weekly")
          finalRepeatDays = [...selectedWeekDays];
        if (selectedRepeat === "monthly")
          finalRepeatDays = [...selectedMonthDays];

        if (editingTaskId) {
          const taskIndex = tasks.findIndex((t) => t.id === editingTaskId);
          if (taskIndex > -1) {
            tasks[taskIndex].title = title;
            tasks[taskIndex].time = time;
            tasks[taskIndex].note = noteVal;
            tasks[taskIndex].tag = selectedTag;
            tasks[taskIndex].repeatType = selectedRepeat;
            tasks[taskIndex].repeatDays = finalRepeatDays;
            tasks[taskIndex].specificDate =
              selectedRepeat === "once" || selectedRepeat === "yearly"
                ? dateVal
                : null;
            alert("Cập nhật thành công!");
          }
        } else {
          const newTask = {
            id: Date.now(),
            title,
            time,
            note: noteVal,
            tag: selectedTag,
            repeatType: selectedRepeat,
            repeatDays: finalRepeatDays,
            specificDate:
              selectedRepeat === "once" || selectedRepeat === "yearly"
                ? dateVal
                : null,
            completedDates: [],
          };
          tasks.push(newTask);
          alert("Đã thêm thành công!");
        }

        localStorage.setItem("tasks", JSON.stringify(tasks));
        cancelEdit();
        renderTaskList();

        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        renderTaskPreviews(getLocalISODate(today), "todayPreview");
        renderTaskPreviews(getLocalISODate(tomorrow), "tomorrowPreview");
        renderCalendar();
      });

      // Other utility functions (renderTaskList, delete, modals) remain same...
      function getTagBadge(tag) {
        const map = {
          normal: '<span class="badge-tag badge-normal">Bình thường</span>',
          important:
            '<span class="badge-tag badge-important">Quan trọng</span>',
          work: '<span class="badge-tag badge-work">Công việc</span>',
          study: '<span class="badge-tag badge-study">Học tập</span>',
        };
        return map[tag] || map["normal"];
      }

      function renderTaskList() {
        const list = document.getElementById("taskList");
        list.innerHTML = "";

        tasks.forEach((task) => {
          const el = document.createElement("div");
          el.className =
            "bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center";

          let repeatBadge = "";
          if (task.repeatType === "daily")
            repeatBadge =
              '<span class="text-xs bg-purple-100 text-purple-600 px-2 py-0.5 rounded-full">Hàng ngày</span>';
          else if (task.repeatType === "monthly") {
            // Show days
            const days =
              task.repeatDays && task.repeatDays.length
                ? task.repeatDays.join(", ")
                : new Date(task.specificDate).getDate();
            repeatBadge = `<span class="text-xs bg-pink-100 text-pink-600 px-2 py-0.5 rounded-full">Ngày ${days} h.tháng</span>`;
          } else if (task.repeatType === "once")
            repeatBadge = `<span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">${task.specificDate}</span>`;
          else if (task.repeatType === "yearly")
            repeatBadge = `<span class="text-xs bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full">Hàng năm: ${task.specificDate.slice(
              5
            )}</span>`;
          else
            repeatBadge = `<span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">T${task.repeatDays
              .map((d) => (d + 1 == 1 ? 8 : d + 1))
              .join(",")}</span>`;

          const noteIcon = task.note
            ? `<span class="text-xs text-gray-400 ml-2" title="Có ghi chú"><i class="fas fa-sticky-note"></i></span>`
            : "";

          el.innerHTML = `
                    <div class="flex-1">
                        <div class="font-bold text-gray-800">${task.title}</div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs font-mono text-gray-500"><i class="far fa-clock"></i> ${
                              task.time
                            }</span>
                            ${repeatBadge}
                            ${getTagBadge(task.tag)}
                            ${noteIcon}
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editTask(${
                          task.id
                        })" class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-50 text-blue-500 hover:bg-blue-100 transition"><i class="fas fa-pen text-sm"></i></button>
                        <button onclick="confirmDeleteTask(${
                          task.id
                        })" class="w-8 h-8 flex items-center justify-center rounded-full bg-red-50 text-red-500 hover:bg-red-100 transition"><i class="fas fa-trash-alt text-sm"></i></button>
                    </div>
                `;
          list.appendChild(el);
        });
      }

      // Standard helpers
      function renderTaskPreviews(dateStr, containerId) {
        const container = document.getElementById(containerId);
        const tasksList = getTasksForDate(dateStr);
        container.innerHTML = "";
        if (tasksList.length === 0) {
          const emptyText =
            containerId === "todayPreview"
              ? "Hôm nay rảnh rỗi!"
              : "Ngày mai chưa có lịch.";
          container.innerHTML = `<div class="p-4 text-center text-gray-400 bg-gray-50 rounded-xl border border-dashed border-gray-200 text-xs">${emptyText}</div>`;
          return;
        }
        tasksList.slice(0, 3).forEach((task) => {
          const isDone = task.completedDates.includes(dateStr);
          const el = document.createElement("div");
          const isTomorrow = containerId === "tomorrowPreview";
          let borderClass = "";
          if (isTomorrow) {
            borderClass = "bg-gray-50 border-gray-100 opacity-80";
          } else {
            borderClass =
              task.tag === "important" && !isDone
                ? "border-red-200 bg-red-50"
                : isDone
                ? "bg-green-50 border-green-100"
                : "bg-white border-gray-100 shadow-sm";
          }

          el.className = `flex items-center justify-between p-3 rounded-xl border ${borderClass}`;
          el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ${
                          isDone
                            ? "bg-green-100 text-green-600"
                            : task.tag === "important"
                            ? "bg-red-100 text-red-500"
                            : "bg-blue-50 text-blue-500"
                        }">
                            <i class="fas ${
                              isDone
                                ? "fa-check"
                                : task.tag === "important"
                                ? "fa-exclamation"
                                : "fa-clock"
                            }"></i>
                        </div>
                        <div>
                            <div class="text-sm font-bold ${
                              isDone
                                ? "text-gray-500 line-through"
                                : "text-gray-800"
                            }">${task.title}</div>
                            <div class="flex items-center gap-2 mt-0.5">
                                <span class="text-xs text-gray-500">${
                                  task.time
                                }</span>
                                ${getTagBadge(task.tag)}
                            </div>
                        </div>
                    </div>
                `;
          el.onclick = () => openDayModal(dateStr);
          container.appendChild(el);
        });
      }

      function confirmDeleteTask(id) {
        pendingDeleteId = id;
        document.getElementById("confirmModal").classList.add("open");
      }
      function closeConfirmModal() {
        document.getElementById("confirmModal").classList.remove("open");
        pendingDeleteId = null;
      }
      function executeDelete() {
        if (pendingDeleteId) {
          if (pendingDeleteId === editingTaskId) cancelEdit();
          tasks = tasks.filter((t) => t.id !== pendingDeleteId);
          localStorage.setItem("tasks", JSON.stringify(tasks));
          renderTaskList();
          if (currentView === "calendar") {
            renderCalendar();
            renderTaskPreviews(getLocalISODate(new Date()), "todayPreview");
          }
          if (currentView === "profile") renderProfile();
        }
        closeConfirmModal();
      }

      function openNoteModal(encodedNote) {
        const note = decodeURIComponent(encodedNote);
        document.getElementById("noteContent").innerText = note;
        document.getElementById("noteModal").classList.add("open");
      }
      function closeNoteModal() {
        document.getElementById("noteModal").classList.remove("open");
      }

      function openDayModal(dateStr) {
        selectedDateStr = dateStr;
        const modal = document.getElementById("dayModal");
        const list = document.getElementById("modalTaskList");
        const [y, m, d] = dateStr.split("-");
        document.getElementById("modalDateTitle").innerText = `${d}/${m}/${y}`;
        list.innerHTML = "";
        const dayTasks = getTasksForDate(dateStr);
        if (dayTasks.length === 0) {
          list.innerHTML = `<div class="text-center text-gray-400 py-10">Không có nhiệm vụ nào</div>`;
        } else {
          dayTasks.forEach((task) => {
            const isDone = task.completedDates.includes(dateStr);
            const div = document.createElement("div");
            const borderClass =
              task.tag === "important" && !isDone
                ? "border-red-200 bg-red-50"
                : "bg-gray-50 border-gray-100";
            const doneBtnClass = isDone
              ? "bg-green-100 text-green-600 cursor-not-allowed opacity-50"
              : "bg-gray-100 text-gray-400 hover:bg-green-500 hover:text-white transition";
            const doneIcon = isDone ? "fa-check-circle" : "fa-check";
            const doneAction = isDone
              ? ""
              : `toggleTask(${task.id}, '${dateStr}')`;
            let noteBtnHTML = "";
            if (task.note && task.note.trim() !== "") {
              const encodedNote = encodeURIComponent(task.note);
              noteBtnHTML = `<button onclick="openNoteModal('${encodedNote}')" class="w-10 h-10 rounded-xl bg-blue-50 text-blue-500 hover:bg-blue-100 flex items-center justify-center transition"><i class="fas fa-sticky-note"></i></button>`;
            }
            div.className = `flex items-center justify-between p-3 rounded-xl border ${borderClass} mb-2`;
            div.innerHTML = `
                        <div class="flex-1">
                            <div class="text-sm font-bold text-gray-800 ${
                              isDone ? "line-through opacity-50" : ""
                            }">${task.title}</div>
                            <div class="flex items-center gap-2 mt-0.5">
                                <div class="text-xs text-gray-500">${
                                  task.time
                                }</div>
                                ${getTagBadge(task.tag)}
                            </div>
                        </div>
                        <div class="flex gap-2 items-center">
                            ${noteBtnHTML}
                            <button onclick="${doneAction}" class="w-10 h-10 rounded-xl ${doneBtnClass} flex items-center justify-center shadow-sm"><i class="fas ${doneIcon} text-lg"></i></button>
                        </div>
                    `;
            list.appendChild(div);
          });
        }
        modal.classList.add("open");
      }
      function closeModal() {
        document.getElementById("dayModal").classList.remove("open");
        if (currentView === "calendar") {
          renderCalendar();
          const t = new Date();
          renderTaskPreviews(getLocalISODate(t), "todayPreview");
        }
      }
      function toggleTask(id, dateStr) {
        const task = tasks.find((t) => t.id === id);
        if (!task) return;
        if (task.completedDates.includes(dateStr)) return;
        task.completedDates.push(dateStr);
        localStorage.setItem("tasks", JSON.stringify(tasks));
        openDayModal(dateStr);
      }
      function renderProfile() {
        let total = 0;
        tasks.forEach((t) => (total += t.completedDates.length));
        document.getElementById("totalTasksCount").innerText = total;
        let streak = 0;
        const today = new Date();
        for (let i = 0; i < 365; i++) {
          const d = new Date();
          d.setDate(today.getDate() - i);
          const dStr = d.toISOString().split("T")[0];
          let hasDone = tasks.some((t) => t.completedDates.includes(dStr));
          if (hasDone) streak++;
          else if (i > 0) break;
        }
        document.getElementById("streakCount").innerText = streak;
        const graph = document.getElementById("contributionGraph");
        graph.innerHTML = "";
        for (let i = 59; i >= 0; i--) {
          const d = new Date();
          d.setDate(today.getDate() - i);
          const dStr = d.toISOString().split("T")[0];
          let count = 0;
          tasks.forEach((t) => {
            if (t.completedDates.includes(dStr)) count++;
          });
          const box = document.createElement("div");
          let cls = "contrib-box";
          if (count > 0) cls += " contrib-1";
          if (count > 2) cls += " contrib-2";
          if (count > 4) cls += " contrib-3";
          if (count > 6) cls += " contrib-4";
          box.className = cls;
          graph.appendChild(box);
        }
      }
      function clearAllData() {
        if (confirm("Xóa toàn bộ dữ liệu?")) {
          localStorage.clear();
          location.reload();
        }
      }
    </script>
  </body>
</html>
